version: "2"

services:
  kafka:
    image: registry-vpc.cn-hangzhou.aliyuncs.com/idcos-common/kafka:2.8.1
    container_name: kafka
    network_mode: "host"
    volumes:
      - kafka_data:/bitnami
    environment:
      - TZ=Asia/Shanghai
      - KAFKA_BROKER_ID={{ ansible_play_hosts.index(inventory_hostname) + 1 }}
      - KAFKA_CFG_ZOOKEEPER_CONNECT={{ groups['middleware'] | map('extract', hostvars, ['private_ip']) | join(':2181,') + ':2181' }}
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=INTERNAL:SASL_PLAINTEXT,CLIENT:SASL_PLAINTEXT
      - KAFKA_CFG_LISTENERS=CLIENT://:9092
      - KAFKA_CFG_ADVERTISED_LISTENERS=CLIENT://{{ private_ip }}:9092
      - KAFKA_INTER_BROKER_USER={{ KAFKA_USER }}
      - KAFKA_INTER_BROKER_PASSWORD={{ KAFKA_PASSWORD }}
      - KAFKA_INTER_BROKER_LISTENER_NAME=CLIENT
      - KAFKA_CFG_SASL_ENABLED_MECHANISMS=PLAIN
      - KAFKA_CFG_SASL_MECHANISM_INTER_BROKER_PROTOCOL=PLAIN
      - KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE=true
      - KAFKA_CFG_ALLOW_EVERYONE_IF_NO_ACL_FOUND=true
      - KAFKA_ZOOKEEPER_PROTOCOL=SASL_PLAINTEXT
      - KAFKA_ZOOKEEPER_USER={{ ZOOKEEPER_USER }}
      - KAFKA_ZOOKEEPER_PASSWORD={{ ZOOKEEPER_PASSWORD }}
      - KAFKA_CLIENT_USERS={{ KAFKA_USER }}
      - KAFKA_CLIENT_PASSWORDS={{ KAFKA_PASSWORD }}
      - KAFKA_CFG_MESSAGE_MAX_BYTES=104857600
      - KAFKA_CFG_MAX_REQUEST_SIZE=104857600
      - KAFKA_CFG_REPLICA_FETCH_MAX_BYTES=104857600
      - KAFKA_CFG_REPLICA_FETCH_WAIT_MAX_MS=2000
      - KAFKA_CFG_FETCH_MESSAGE_MAX_BYTES=104857600
      - KAFKA_CFG_NUM_PARTITIONS=3
      - KAFKA_CFG_GROUP_INITIAL_REBALANCE_DELAY_MS=3
      - KAFKA_CFG_MAX_POLL_RECORDS=20
      - KAFKA_CFG_SESSION_TIMEOUT_MS=900000
      - KAFKA_CFG_HEARTBEAT_INTERVAL_MS=200000
      - KAFKA_CFG_MAX_POLL_INTERVAL_MS=900000
    restart: always

volumes:
  kafka_data:
    driver: local
